{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π</title>
  <link rel="stylesheet" href="{% static 'inspector/css/style.css' %}">
</head>
<body>
  <h1>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π</h1>

  <button onclick="addViolation()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

  <table border="1" id="dbTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>–î–∞—Ç–∞</th>
        <th>–ê—ç—Ä–æ–ø–æ—Ä—Ç</th>
        <th>–†–µ–π—Å</th>
        <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
        <th>–ü—Ä–∏–ª–µ—Ç/–í—ã–ª–µ—Ç</th>
        <th>–í—Ä–µ–º—è —Ä–µ–π—Å–∞ (—Å)</th>
        <th>–í—Ä–µ–º—è —Ä–µ–π—Å–∞ (–¥–æ)</th>
        <th>–°–µ–∫—Ç–æ—Ä</th>
        <th>–í—Ä–µ–º—è –Ω–∞—Ä—É—à–µ–Ω–∏—è (—Å)</th>
        <th>–í—Ä–µ–º—è –Ω–∞—Ä—É—à–µ–Ω–∏—è (–¥–æ)</th>
        <th>–°–ª—É–∂–±–∞</th>
        <th>–ù–∞—Ä—É—à–µ–Ω–∏–µ</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã</th>
        <th>–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä</th>
        <th>–°–º–µ–Ω–∞</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for v in violations %}
      <tr data-id="{{ v.id }}">
        <td>{{ v.id }}</td>
        <td>{{ v.date|date:"Y-m-d" }}</td>
        <td>{{ v.airport }}</td>
        <td>{{ v.flight }}</td>
        <td>{{ v.direction }}</td>
        <td>{{ v.type }}</td>
        <td>{{ v.time_start|time:"H:i" }}</td>
        <td>{{ v.time_end|time:"H:i" }}</td>
        <td>{{ v.sector }}</td>
        <td>{{ v.violation_start|time:"H:i" }}</td>
        <td>{{ v.violation_end|time:"H:i" }}</td>
        <td>{{ v.service }}</td>
        <td>{{ v.violation }}</td>
        <td>{{ v.description }}</td>
        <td>{{ v.supervisor }}</td>
        <td>{{ v.inspector }}</td>
        <td>{{ v.shift }}</td>
        <td>{{ v.status }}</td>
        <td>
          <button onclick="startEditing(this)">‚úèÔ∏è</button>
          <button onclick="deleteViolation({{ v.id }})">üóëÔ∏è</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length+1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ
  function deleteViolation(id) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ‚Ññ" + id + "?")) return;
    fetch(`/inspector/delete_violation/${id}/`, {
      method: "POST",
      headers: {"X-CSRFToken": getCookie("csrftoken")}
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("–£–¥–∞–ª–µ–Ω–æ!");
        location.reload();
      } else {
        alert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"));
      }
    });
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
  function addViolation() {
    const newObj = {
      date: new Date().toISOString().slice(0,10),
      airport: "", flight: "", direction: "", type: "",
      time_start: "", time_end: "",
      sector: "", violation_start: "", violation_end: "",
      service: "", violation: "", description: "",
      supervisor: "", inspector: "", shift: "", status: ""
    };

    fetch("/inspector/add_violation/", {
      method: "POST",
      headers: {"Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken")},
      body: JSON.stringify(newObj)
    })
    .then(res => res.json())
    .then(data => {
      if (data.id) {
        alert("–î–æ–±–∞–≤–ª–µ–Ω–æ!");
        location.reload();
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏");
      }
    });
  }

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  function startEditing(btn) {
    const row = btn.closest("tr");
    const id = row.dataset.id;
    const cells = row.querySelectorAll("td");

    const current = Array.from(cells).map(td => td.textContent.trim());

    cells[1].innerHTML = `<input type="date" value="${current[1]}">`;
    cells[2].innerHTML = `<input type="text" value="${current[2]}">`;
    cells[3].innerHTML = `<input type="text" value="${current[3]}">`;
    cells[4].innerHTML = `<input type="text" value="${current[4]}">`;
    cells[5].innerHTML = `<select>
        <option value="–ü—Ä–∏–ª–µ—Ç" ${current[5]==="–ü—Ä–∏–ª–µ—Ç"?"selected":""}>–ü—Ä–∏–ª–µ—Ç</option>
        <option value="–í—ã–ª–µ—Ç" ${current[5]==="–í—ã–ª–µ—Ç"?"selected":""}>–í—ã–ª–µ—Ç</option>
      </select>`;
    cells[6].innerHTML = `<input type="time" value="${current[6]}">`;
    cells[7].innerHTML = `<input type="time" value="${current[7]}">`;
    cells[8].innerHTML = `<input type="text" value="${current[8]}">`;
    cells[9].innerHTML = `<input type="time" value="${current[9]}">`;
    cells[10].innerHTML = `<input type="time" value="${current[10]}">`;
    cells[11].innerHTML = `<input type="text" value="${current[11]}">`;
    cells[12].innerHTML = `<input type="text" value="${current[12]}">`;
    cells[13].innerHTML = `<input type="text" value="${current[13]}">`;
    cells[14].innerHTML = `<input type="text" value="${current[14]}">`;
    cells[15].innerHTML = `<input type="text" value="${current[15]}">`;
    cells[16].innerHTML = `<input type="text" value="${current[16]}">`;
    cells[17].innerHTML = `<button onclick="saveEdit(${id}, this)">üíæ</button>
                            <button onclick="location.reload()">‚ùå</button>`;
  }

  function saveEdit(id, btn) {
    const row = btn.closest("tr");
    const cells = row.querySelectorAll("td");

    const updated = {
      date: cells[1].querySelector("input")?.value || "",
      airport: cells[2].querySelector("input")?.value || "",
      flight: cells[3].querySelector("input")?.value || "",
      direction: cells[4].querySelector("input")?.value || "",
      type: cells[5].querySelector("select")?.value || "",
      time_start: cells[6].querySelector("input")?.value || "",
      time_end: cells[7].querySelector("input")?.value || "",
      sector: cells[8].querySelector("input")?.value || "",
      violation_start: cells[9].querySelector("input")?.value || "",
      violation_end: cells[10].querySelector("input")?.value || "",
      service: cells[11].querySelector("input")?.value || "",
      violation: cells[12].querySelector("input")?.value || "",
      description: cells[13].querySelector("input")?.value || "",
      supervisor: cells[14].querySelector("input")?.value || "",
      inspector: cells[15].querySelector("input")?.value || "",
      shift: cells[16].querySelector("input")?.value || "",
      status: cells[17].querySelector("input")?.value || ""
    };

    fetch(`/inspector/edit_violation/${id}/`, {
      method: "POST",
      headers: {"Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken")},
      body: JSON.stringify(updated)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
        location.reload();
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
      }
    });
  }
  </script>
</body>
</html>
